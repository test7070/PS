z_quatp_gu01:--z_quatp_gu01

declare @t_noa nvarchar(50)

set @t_noa = case when '#non' = [1] then '' else [1] end
--------------------------------------------------------------------------------

SET QUOTED_IDENTIFIER OFF

declare @tmp table(
	gno nvarchar(1),
	rec int,
	q_productno nvarchar(30),
	q_product nvarchar(100),
	product nvarchar(100),
	spec1 nvarchar(50),
	spec2 nvarchar(50),
	memo nvarchar(50),
	total float
)
insert into @tmp
select '0',ROW_NUMBER() over (partition by LEFT(a.productno,7) order by a.product),a.productno,REPLACE(a.product,'~#$',"'"),b.product,a.spec,b.spec,a.memo,a.total
from view_quats a
left join ucas b on a.productno = b.noa 
left join ucc c on a.productno = c.noa
where a.noa = @t_noa

update @tmp set gno = case when product is not null then '8' else '4' end 
update @tmp set product = dbo.split(dbo.split(product,':',1),' ',0) 

declare @rec nvarchar(100)
declare @q_productno nvarchar(30)
declare @q_xproductno nvarchar(30)  
declare @product nvarchar(100)
declare @xproduct nvarchar(100)
declare @cnt int
declare @i int
declare @str nvarchar(100)

set @q_xproductno = 'xxxxxx'
set @xproduct = 'xxxxxx'
 
declare cursor_table cursor for 
select rec,q_productno,product from @tmp where gno = '8' 
open cursor_table 
fetch next from cursor_table 
into @rec,@q_productno,@product
while(@@FETCH_STATUS <> -1) 
begin
	if(@q_productno != @q_xproductno)
	begin
		insert into @tmp(gno,q_productno,q_product,memo,total)
		select '1',q_productno,q_product,memo,total from @tmp where gno = '8' and rec = @rec
	end
	if(@product != @xproduct)
	begin 
				
		set @cnt = (select COUNT(*) from @tmp where gno = '8' and q_productno = @q_productno and product = @product)
		set @i = 0
		set @str = ''
		while(@i < @cnt)
		begin
			if(@i = 0)
			begin
				set @str = @str + (select spec2 from @tmp where gno = '8' and rec = @rec+@i and  q_productno = @q_productno and product = @product)
				set @i = @i +1	
			end	
			else
			begin	
				set @str = @str + ',' + (select spec2 from @tmp where gno = '8' and rec = @rec+@i and  q_productno = @q_productno and product = @product)
				set @i = @i +1
			end
		end		
		insert into @tmp(gno,q_productno,product,spec1)
		values('2',@q_productno,@product,@str)
	end
		
	set @q_xproductno = @q_productno
	set @xproduct = @product
	
	fetch next from cursor_table 
	into @rec,@q_productno,@product	
end 
close cursor_table 
deallocate cursor_table 
 
delete @tmp where gno = '8'

declare @q_product nvarchar(100)
declare @q_xproduct nvarchar(100)  

set @q_xproduct = 'xxxxxx'

declare cursor_table cursor for 
select rec,q_productno,q_product from @tmp where gno = '4' 
open cursor_table 
fetch next from cursor_table 
into @rec,@q_productno,@q_product
while(@@FETCH_STATUS <> -1) 
begin
	if(@q_product != @q_xproduct)
	begin 
		insert into @tmp(gno,q_productno,q_product,memo)
		select '3',q_productno,q_product,memo from @tmp where gno = '4' and rec = @rec and q_product = @q_product
	end	
	set @q_xproduct = @q_product
	
	fetch next from cursor_table 
	into @rec,@q_productno,@q_product	
end 
close cursor_table 
deallocate cursor_table 
 
select 
	gno,DENSE_RANK() over (order by left(q_productno,7)) rec,
	q_productno,q_product,product,spec1,memo,dbo.getComma(total,0) total 
from @tmp order by q_productno,gno  ;